#!/usr/bin/env bash

set -e

GREEN=$'\033[0;32m'
BLUE=$'\033[0;34m'
BOLD=$'\033[1m'
NC=$'\033[0m'

if [ -z "$1" ]; then
    printf "Usage: %s <host> [ssh-options...]\n" "$0" >&2
    exit 1
fi

HOST="$1"
shift

msg() {
    printf "${BLUE}==>${NC} %s" "$*" >&2
}

msg "Waiting for ${BOLD}$HOST${NC} to be online (ping)..."
while ! ping -c 1 -W 1 "$HOST" &> /dev/null; do
    sleep 1
done
printf " ${GREEN}Online.${NC}\n" >&2

msg "Waiting for port 22 on ${BOLD}$HOST${NC}..."
while ! nc -z -w 1 "$HOST" 22 2>/dev/null; do
    sleep 1
done
printf " ${GREEN}Open.${NC}\n" >&2

printf "${BLUE}==>${NC} ${GREEN}Connecting...${NC}\n" >&2
exec ssh "$HOST" "$@"
